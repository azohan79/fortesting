name: CI Pipeline

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  test:
    name: Run Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest requests junitparser

      - name: Run pytest with XML output
        run: |
          pytest tests/ --junitxml=pytest_results.xml

      - name: Upload Pytest Results
        uses: actions/upload-artifact@v4
        with:
          name: pytest-results
          path: pytest_results.xml

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install coverage requests

      - name: Run tests with coverage
        run: |
          coverage run -m pytest
          coverage xml

      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Download SonarCloud report via API
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          echo "üîç Downloading SonarCloud issues as JSON"
          python <<EOF
import requests
import os

token = os.getenv("SONAR_TOKEN")
project = "azohan79_fortesting"
org = "azohan79"

url = f"https://sonarcloud.io/api/issues/search?organization={org}&componentKeys={project}&ps=500"
resp = requests.get(url, headers={"Authorization": f"Bearer {token}"})
resp.raise_for_status()

with open("sonar-report.json", "w") as f:
    f.write(resp.text)

print("‚úÖ sonar-report.json saved.")
EOF

      - name: Upload SonarCloud report JSON
        uses: actions/upload-artifact@v4
        with:
          name: sonar-report
          path: sonar-report.json


  zap_scan:
    name: OWASP ZAP Manual Scan
    runs-on: ubuntu-latest
    needs: [test, sonarcloud]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Run ZAP Full Scan
        run: |
          docker run --rm \
            --user root \
            -v $(pwd):/zap/wrk \
            ghcr.io/zaproxy/zaproxy:stable \
            sh -c "\
              zap-full-scan.py \
                -t http://test.anywatt.es \
                -J zap_report.json \
                -w zap_report.md \
                -r zap_report.html \
                -a || true"

      - name: Upload ZAP Reports
        uses: actions/upload-artifact@v4
        with:
          name: zap-report
          path: |
            zap_report.json
            zap_report.md
            zap_report.html

  gpt_analysis:
    name: Generate GPT Security QA Report
    runs-on: ubuntu-latest
    needs: [zap_scan]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install GPT dependencies
        run: |
          pip install openai junitparser

      - name: Run GPT Analysis Script
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python .github/scripts/gpt_analysis.py

      - name: Upload GPT Report
        uses: actions/upload-artifact@v4
        with:
          name: gpt-report
          path: gpt_report.html
